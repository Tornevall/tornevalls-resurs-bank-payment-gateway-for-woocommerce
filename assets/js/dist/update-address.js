(()=>{"use strict";const e=window.jQuery;class t{constructor(){this.getAddressCustomerType=void 0,this.getAddressWidget=void 0}initialize(){console.log("Legacy Updater"),e(document).on("update_resurs_customer_type",((t,s)=>{e.ajax({url:`${rbCustomerTypeData.apiUrl}&customerType=${s}`})})),e(document).ready((()=>{if("function"==typeof Resursbank_GetAddress&&null!==document.getElementById("rb-ga-widget")){this.getAddressWidget=new Resursbank_GetAddress({updateAddress:e=>{this.getAddressCustomerType=this.getAddressWidget.getCustomerType(),this.rbHandleFetchAddressResponse(e,this.getAddressCustomerType)}});try{this.getAddressWidget.setupEventListeners();const t=this.getAddressWidget.getCustomerTypeElNatural(),s=this.getAddressWidget.getCustomerTypeElLegal();t.addEventListener("change",(()=>{e("body").trigger("update_resurs_customer_type",["NATURAL"])})),s.addEventListener("change",(()=>{e("body").trigger("update_resurs_customer_type",["LEGAL"])}))}catch(e){console.log(e)}}}))}rbHandleFetchAddressResponse=(()=>{const t=e=>e.hasAttribute("name"),s=e=>e.name.startsWith("billing"),r=e=>e.name.startsWith("shipping"),a=e=>{let t;switch(e.split("billing_")[1]||e.split("shipping_")[1]){case"first_name":t="firstName";break;case"last_name":t="lastName";break;case"country":t="countryCode";break;case"address_1":t="addressRow1";break;case"address_2":t="addressRow2";break;case"postcode":t="postalCode";break;case"city":t="postalArea";break;case"company":t="fullName";break;default:t=""}return t},d=e=>({name:a(e.name),el:e}),i=e=>""!==e.name,n=e=>e.map(d).filter(i),o=(a,d)=>{const i=(e=>{let a=null;if(e instanceof HTMLFormElement){const d=Array.from(e.elements).filter(t);a={billing:n(d.filter(s)),shipping:n(d.filter(r))}}return a})((()=>{const e=document.forms.checkout;return e instanceof HTMLFormElement?e:null})()),o=e("#billing_resurs_government_id");if(void 0!==this.getAddressWidget&&"LEGAL"===d){const e=this.getAddressWidget.getGovIdElement();o.length>0&&o.val(e.value)}i?.billing.forEach((e=>{const t=a[e.name],s="string"==typeof t?t:e.el.value;"fullName"===e.name?"LEGAL"===d?e.el.value=s:(e.el.value="",o.val("")):e.el.value=s,"object"==typeof e.el.parentNode?.parentNode?.classList&&e.el.parentNode.parentNode.classList.contains("woocommerce-invalid")&&(e.el.parentNode.parentNode.classList.remove("woocommerce-invalid"),e.el.parentNode.parentNode.classList.remove("woocommerce-invalid-required-field"))}))},c=e("#billing_resurs_government_id");return(t,s)=>{try{c.length>0&&("LEGAL"===s?e("#rb-customer-widget-getAddress-input-govId").length>0&&c.val(e("#rb-customer-widget-getAddress-input-govId").val()):c.val("")),o(t,s),rbUpdateCustomerType()}catch(e){console.log(e)}}})()}const s=window.wp.data,r=window.wc.wcBlocksData;class a{widget=null;constructor(){this.widget=new Resursbank_GetAddress({updateAddress:e=>{this.resetCartData();let t=this.getCartData();const a={first_name:"firstName",last_name:"lastName",address_1:"addressRow1",address_2:"addressRow2",postcode:"postalCode",city:"postalArea",country:"countryCode",company:"fullName"};for(const[s,r]of Object.entries(a)){if(!e.hasOwnProperty(r))throw new Error(`Missing required field "${r}" in data object.`);if("company"!==s)t.shippingAddress[s]="string"==typeof e[r]?e[r]:"";else if("string"==typeof e[r]&&"LEGAL"===this.widget.getCustomerType()){t.shippingAddress.company=e[r];continue}}(0,s.dispatch)(r.CART_STORE_KEY).setCartData(t)}})}initialize(){this.widget.setupEventListeners()}getCartData(){const e=(0,s.select)(r.CART_STORE_KEY).getCartData();if(!e.shippingAddress)throw new Error("Missing shipping address data in cart.");const t=["first_name","last_name","address_1","address_2","postcode","city","country","company"];for(const s of t)if(void 0===e.shippingAddress[s])throw new Error(`Missing required field "${s}" in shipping address data.`);return e}resetCartData(){let e=this.getCartData();e.shippingAddress.first_name="",e.shippingAddress.last_name="",e.shippingAddress.address_1="",e.shippingAddress.address_2="",e.shippingAddress.postcode="",e.shippingAddress.city="",e.shippingAddress.country="",e.shippingAddress.company="",(0,s.dispatch)(r.CART_STORE_KEY).setCartData(e)}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelector(".woocommerce-checkout")&&"function"==typeof Resursbank_GetAddress&&(document.querySelector(".wc-block-components-form")?(new a).initialize():(new t).initialize())}))})();