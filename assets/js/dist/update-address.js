(()=>{"use strict";const e=window.jQuery;class t{constructor(){this.getAddressEnabled="1"===rbFrontendData?.getAddressEnabled||!0===rbFrontendData?.getAddressEnabled,this.getAddressWidget=void 0}updateCustomerType(t){const s=rbFrontendData?.apiUrl;s?e.ajax({url:`${s}&customerType=${t}`}).done((()=>{e(document.body).trigger("update_checkout")})).fail((e=>{console.error("Error updating customer type:",e)})):console.error("API URL is undefined")}initialize(){this.getAddressEnabled?(console.log("Legacy Address Fetcher Loaded."),e(document).ready((()=>{if("function"==typeof Resursbank_GetAddress&&document.getElementById("rb-ga-widget")){this.getAddressWidget=new Resursbank_GetAddress({updateAddress:e=>{this.handleFetchAddressResponse(e),this.updateCustomerType(this.getAddressWidget.getCustomerType())}});try{this.setupCustomerTypeOnInit(),this.getAddressWidget.setupEventListeners()}catch(e){console.error("Error initializing address widget:",e)}}}))):console.log("Legacy Address Fetcher is disabled.")}setupCustomerTypeOnInit(){const t=e("#billing_company"),s=()=>{const e=t.length>0&&""!==t.val().trim()?"LEGAL":"NATURAL";this.updateCustomerType(e)};s(),t.on("input change",s)}handleFetchAddressResponse=(()=>{const e=e=>{let t="";switch(e.split("billing_")[1]||e.split("shipping_")[1]){case"first_name":t="firstName";break;case"last_name":t="lastName";break;case"country":t="countryCode";break;case"address_1":t="addressRow1";break;case"address_2":t="addressRow2";break;case"postcode":t="postalCode";break;case"city":t="postalArea";break;case"company":t="fullName";break;default:t=""}return t},t=t=>t.map((t=>({name:e(t.name),el:t}))).filter((e=>""!==e.name)),s=(e,t)=>{e.forEach((({name:e,el:s})=>{var a;const n=null!==(a=t[e])&&void 0!==a?a:s.value;"fullName"===e&&"LEGAL"!==this.getAddressWidget.getCustomerType()?s.value="":s.value=n;const r=s.closest(".woocommerce-invalid");r&&r.classList.remove("woocommerce-invalid","woocommerce-invalid-required-field")}))};return e=>{try{const a=(e=>{if(!e)return null;const s=Array.from(e.elements).filter((e=>e.name));return{billing:t(s.filter((e=>e.name.startsWith("billing_")))),shipping:t(s.filter((e=>e.name.startsWith("shipping_"))))}})((()=>{const e=document.forms.checkout;return e instanceof HTMLFormElement?e:null})());a&&s(a.billing,e)}catch(e){console.error("Error updating address fields:",e)}}})()}const s=window.wp.data,a=window.wc.wcBlocksData,n=window.wc.wcSettings;class r{widget=null;allPaymentMethods=[];constructor(){this.widget=new Resursbank_GetAddress({updateAddress:e=>{this.resetCartData();let t=this.getCartData();const n={first_name:"firstName",last_name:"lastName",address_1:"addressRow1",address_2:"addressRow2",postcode:"postalCode",city:"postalArea",country:"countryCode",company:"fullName"};for(const[s,a]of Object.entries(n)){if(!e.hasOwnProperty(a))throw new Error(`Missing required field "${a}" in data object.`);if("company"===s){this.setBillingAndShipping(t,"string"==typeof e[a]&&"LEGAL"===this.widget.getCustomerType()?e[a]:"");continue}const n="string"==typeof e[a]?e[a]:"";t.shippingAddress[s]=n,t.billingAddress[s]=n}(0,s.dispatch)(a.CART_STORE_KEY).setCartData(t),this.refreshPaymentMethods()}})}setBillingAndShipping(e,t){e.shippingAddress.company=t,e.billingAddress.company=t}initialize(){(0,s.select)(a.CART_STORE_KEY).hasFinishedResolution("getCartData")||(0,s.dispatch)(a.CART_STORE_KEY).invalidateResolution("getCartData"),this.widget.setupEventListeners(),this.loadAllPaymentMethods(),this.refreshPaymentMethods()}loadAllPaymentMethods(){const e=(0,s.select)(a.CART_STORE_KEY).getCartData();e.paymentMethods&&e.paymentMethods.length&&(this.allPaymentMethods=[...e.paymentMethods])}getCartData(){const e=(0,s.select)(a.CART_STORE_KEY).getCartData();if(!e.shippingAddress||["first_name","last_name","address_1","address_2","postcode","city","country","company"].some((t=>void 0===e.shippingAddress[t])))throw new Error("Missing required shipping address data in cart.");return e}resetCartData(){let e=this.getCartData();e.shippingAddress.first_name="",e.shippingAddress.last_name="",e.shippingAddress.address_1="",e.shippingAddress.address_2="",e.shippingAddress.postcode="",e.shippingAddress.city="",e.shippingAddress.country="",e.shippingAddress.company="",(0,s.dispatch)(a.CART_STORE_KEY).setCartData(e)}refreshPaymentMethods(){if(!this.allPaymentMethods.length)return console.log("No payment methods available for filtering."),void this.loadAllPaymentMethods();const e=(0,s.select)(a.CART_STORE_KEY).getCartData();if(!e.paymentMethods)return console.warn("No payment methods found in cart data."),void(0,s.dispatch)(a.CART_STORE_KEY).invalidateResolution("getCartData");const t=(0,n.getSetting)("resursbank_data",{}).payment_methods||[],r=new Set(this.allPaymentMethods.map((e=>e.toLowerCase()))),o=new Map;t.forEach((e=>{const t=(e.id?.toLowerCase()||e.name?.toLowerCase()).trim();o.set(t,e),r.has(t)||this.allPaymentMethods.push(t)}));const i="LEGAL"===this.widget.getCustomerType()||""!==e.billingAddress?.company?.trim(),d=parseInt(e.totals.total_price,10)/Math.pow(10,e.totals.currency_minor_unit),l=this.allPaymentMethods.map((e=>{const t=e?.toLowerCase().trim(),s=o.get(t);if(s){const{enabled_for_legal_customer:t,enabled_for_natural_customer:a,min_purchase_limit:n,max_purchase_limit:r}=s;return(i&&t||!i&&a||!i&&t&&a)&&d>=n&&d<=r?e:null}return e})).filter(Boolean);(0,s.dispatch)(a.CART_STORE_KEY).setCartData({...e,paymentMethods:l})}}document.addEventListener("DOMContentLoaded",(()=>{"1"===rbFrontendData?.getAddressEnabled||!0===rbFrontendData?.getAddressEnabled?document.querySelector(".woocommerce-checkout")&&"function"==typeof Resursbank_GetAddress&&(document.querySelector(".wc-block-components-form")?(console.log("Fetcher init."),(new r).initialize()):new MutationObserver(((e,t)=>{document.querySelector(".wc-block-components-form")&&((new r).initialize(),console.log("Fetcher found and initialized."),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0}),(new t).initialize()):console.log("Address Fetcher is disabled.")}))})();