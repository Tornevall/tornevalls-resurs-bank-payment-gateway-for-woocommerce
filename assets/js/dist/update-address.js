(()=>{"use strict";const e=window.jQuery;class t{constructor(){this.getAddressCustomerType=void 0,this.getAddressWidget=void 0}initialize(){console.log("Legacy Updater"),e(document).on("update_resurs_customer_type",((t,s)=>{e.ajax({url:`${rbCustomerTypeData.apiUrl}&customerType=${s}`})})),e(document).ready((()=>{if("function"==typeof Resursbank_GetAddress&&null!==document.getElementById("rb-ga-widget")){this.getAddressWidget=new Resursbank_GetAddress({updateAddress:e=>{this.getAddressCustomerType=this.getAddressWidget.getCustomerType(),this.rbHandleFetchAddressResponse(e,this.getAddressCustomerType)}});try{this.getAddressWidget.setupEventListeners();const t=this.getAddressWidget.getCustomerTypeElNatural(),s=this.getAddressWidget.getCustomerTypeElLegal();t.addEventListener("change",(()=>{e("body").trigger("update_resurs_customer_type",["NATURAL"])})),s.addEventListener("change",(()=>{e("body").trigger("update_resurs_customer_type",["LEGAL"])}))}catch(e){console.log(e)}}}))}rbHandleFetchAddressResponse=(()=>{const t=e=>e.hasAttribute("name"),s=e=>e.name.startsWith("billing"),a=e=>e.name.startsWith("shipping"),r=e=>{let t;switch(e.split("billing_")[1]||e.split("shipping_")[1]){case"first_name":t="firstName";break;case"last_name":t="lastName";break;case"country":t="countryCode";break;case"address_1":t="addressRow1";break;case"address_2":t="addressRow2";break;case"postcode":t="postalCode";break;case"city":t="postalArea";break;case"company":t="fullName";break;default:t=""}return t},n=e=>({name:r(e.name),el:e}),i=e=>""!==e.name,o=e=>e.map(n).filter(i),d=(r,n)=>{const i=(e=>{let r=null;if(e instanceof HTMLFormElement){const n=Array.from(e.elements).filter(t);r={billing:o(n.filter(s)),shipping:o(n.filter(a))}}return r})((()=>{const e=document.forms.checkout;return e instanceof HTMLFormElement?e:null})()),d=e("#billing_resurs_government_id");if(void 0!==this.getAddressWidget&&"LEGAL"===n){const e=this.getAddressWidget.getGovIdElement();d.length>0&&d.val(e.value)}i?.billing.forEach((e=>{const t=r[e.name],s="string"==typeof t?t:e.el.value;"fullName"===e.name?"LEGAL"===n?e.el.value=s:(e.el.value="",d.val("")):e.el.value=s,"object"==typeof e.el.parentNode?.parentNode?.classList&&e.el.parentNode.parentNode.classList.contains("woocommerce-invalid")&&(e.el.parentNode.parentNode.classList.remove("woocommerce-invalid"),e.el.parentNode.parentNode.classList.remove("woocommerce-invalid-required-field"))}))},l=e("#billing_resurs_government_id");return(t,s)=>{try{l.length>0&&("LEGAL"===s?e("#rb-customer-widget-getAddress-input-govId").length>0&&l.val(e("#rb-customer-widget-getAddress-input-govId").val()):l.val("")),d(t,s),rbUpdateCustomerType()}catch(e){console.log(e)}}})()}const s=window.wp.data,a=window.wc.wcBlocksData,r=window.wc.wcSettings;class n{widget=null;allPaymentMethods=[];constructor(){this.widget=new Resursbank_GetAddress({updateAddress:e=>{this.resetCartData();let t=this.getCartData();const r={first_name:"firstName",last_name:"lastName",address_1:"addressRow1",address_2:"addressRow2",postcode:"postalCode",city:"postalArea",country:"countryCode",company:"fullName"};for(const[s,a]of Object.entries(r)){if(!e.hasOwnProperty(a))throw new Error(`Missing required field "${a}" in data object.`);if("company"===s){this.setBillingAndShipping(t,"string"==typeof e[a]&&"LEGAL"===this.widget.getCustomerType()?e[a]:"");continue}const r="string"==typeof e[a]?e[a]:"";t.shippingAddress[s]=r,t.billingAddress[s]=r}(0,s.dispatch)(a.CART_STORE_KEY).setCartData(t),this.refreshPaymentMethods()}})}setBillingAndShipping(e,t){"Not A Company"===t&&(t=""),e.shippingAddress.company=t,e.billingAddress.company=t}initialize(){this.widget.setupEventListeners(),this.loadAllPaymentMethods()}loadAllPaymentMethods(){const e=(0,s.select)(a.CART_STORE_KEY).getCartData();e.paymentMethods&&e.paymentMethods.length&&(this.allPaymentMethods=[...e.paymentMethods])}getCartData(){const e=(0,s.select)(a.CART_STORE_KEY).getCartData();if(!e.shippingAddress||["first_name","last_name","address_1","address_2","postcode","city","country","company"].some((t=>void 0===e.shippingAddress[t])))throw new Error("Missing required shipping address data in cart.");return e}resetCartData(){let e=this.getCartData();e.shippingAddress.first_name="",e.shippingAddress.last_name="",e.shippingAddress.address_1="",e.shippingAddress.address_2="",e.shippingAddress.postcode="",e.shippingAddress.city="",e.shippingAddress.country="",e.shippingAddress.company="",(0,s.dispatch)(a.CART_STORE_KEY).setCartData(e)}refreshPaymentMethods(){if(!this.allPaymentMethods.length)return console.warn("No payment methods available for filtering."),void this.loadAllPaymentMethods();const e=(0,s.select)(a.CART_STORE_KEY).getCartData();if(!e.paymentMethods)return console.warn("No payment methods found in cart data."),void(0,s.dispatch)(a.CART_STORE_KEY).invalidateResolution("getCartData");const t=(0,r.getSetting)("resursbank_data",{}).payment_methods||[],n=new Map(t.map((e=>[e.id?.toLowerCase()||e.name?.toLowerCase(),e]))),i="LEGAL"===this.widget.getCustomerType(),o=parseInt(e.totals.total_price,10)/Math.pow(10,e.totals.currency_minor_unit),d=this.allPaymentMethods.map((e=>{const t=e?.toLowerCase().trim(),s=n.get(t);if(s){const{enabled_for_legal_customer:t,enabled_for_natural_customer:a,min_purchase_limit:r,max_purchase_limit:n}=s;return(i&&t||!i&&a||!i&&t&&a)&&o>=r&&o<=n?e:null}return e})).filter(Boolean);(0,s.dispatch)(a.CART_STORE_KEY).setCartData({...e,paymentMethods:d})}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelector(".woocommerce-checkout")&&"function"==typeof Resursbank_GetAddress&&(document.querySelector(".wc-block-components-form")?(new n).initialize():new MutationObserver(((e,t)=>{document.querySelector(".wc-block-components-form")&&((new n).initialize(),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0}),(new t).initialize())}))})();