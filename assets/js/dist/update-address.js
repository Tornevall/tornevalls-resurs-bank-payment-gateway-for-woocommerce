(()=>{"use strict";const e=window.jQuery;class t{constructor(){this.getAddressWidget=void 0}updateCustomerType(t){const s=rbCustomerTypeData?.apiUrl;s?e.ajax({url:`${s}&customerType=${t}`}).done((()=>{e(document.body).trigger("update_checkout")})).fail((e=>{console.error("Error updating customer type:",e)})):console.error("API URL is undefined")}initialize(){console.log("Legacy Address Fetcher Loaded."),e(document).ready((()=>{if("function"==typeof Resursbank_GetAddress&&document.getElementById("rb-ga-widget")){this.getAddressWidget=new Resursbank_GetAddress({updateAddress:e=>{this.handleFetchAddressResponse(e),this.updateCustomerType(this.getAddressWidget.getCustomerType())}});try{this.setupCustomerTypeOnInit(),this.getAddressWidget.setupEventListeners()}catch(e){console.error("Error initializing address widget:",e)}}}))}setupCustomerTypeOnInit(){const t=e("#billing_company"),s=t.length>0&&""!==t.val()?"LEGAL":"NATURAL",r=this.getAddressWidget.getCustomerTypeElNatural(),n=this.getAddressWidget.getCustomerTypeElLegal();this.updateCustomerType(s),"LEGAL"===s?n.checked=!0:r.checked=!0}handleFetchAddressResponse=(()=>{const e={first_name:"firstName",last_name:"lastName",country:"countryCode",address_1:"addressRow1",address_2:"addressRow2",postcode:"postalCode",city:"postalArea",company:"fullName"},t=t=>{const s=t.split("_")[1];return e[s]||""},s=e=>e.map((e=>({name:t(e.name),el:e}))).filter((e=>""!==e.name)),r=(e,t)=>{e.forEach((({name:e,el:s})=>{var r;const n=null!==(r=t[e])&&void 0!==r?r:s.value;"fullName"===e&&"LEGAL"!==this.getAddressWidget.getCustomerType()?s.value="":s.value=n;const a=s.closest(".woocommerce-invalid");a&&a.classList.remove("woocommerce-invalid","woocommerce-invalid-required-field")}))};return e=>{try{const t=(e=>{if(!e)return null;const t=Array.from(e.elements).filter((e=>e.name));return{billing:s(t.filter((e=>e.name.startsWith("billing_")))),shipping:s(t.filter((e=>e.name.startsWith("shipping_"))))}})((()=>{const e=document.forms.checkout;return e instanceof HTMLFormElement?e:null})());t&&r(t.billing,e)}catch(e){console.error("Error updating address fields:",e)}}})()}const s=window.wp.data,r=window.wc.wcBlocksData,n=window.wc.wcSettings;class a{widget=null;allPaymentMethods=[];constructor(){this.widget=new Resursbank_GetAddress({updateAddress:e=>{this.resetCartData();let t=this.getCartData();const n={first_name:"firstName",last_name:"lastName",address_1:"addressRow1",address_2:"addressRow2",postcode:"postalCode",city:"postalArea",country:"countryCode",company:"fullName"};for(const[s,r]of Object.entries(n)){if(!e.hasOwnProperty(r))throw new Error(`Missing required field "${r}" in data object.`);if("company"===s){this.setBillingAndShipping(t,"string"==typeof e[r]&&"LEGAL"===this.widget.getCustomerType()?e[r]:"");continue}const n="string"==typeof e[r]?e[r]:"";t.shippingAddress[s]=n,t.billingAddress[s]=n}(0,s.dispatch)(r.CART_STORE_KEY).setCartData(t),this.refreshPaymentMethods()}})}setBillingAndShipping(e,t){"Not A Company"===t&&(t=""),e.shippingAddress.company=t,e.billingAddress.company=t}initialize(){this.widget.setupEventListeners(),this.loadAllPaymentMethods()}loadAllPaymentMethods(){const e=(0,s.select)(r.CART_STORE_KEY).getCartData();e.paymentMethods&&e.paymentMethods.length&&(this.allPaymentMethods=[...e.paymentMethods])}getCartData(){const e=(0,s.select)(r.CART_STORE_KEY).getCartData();if(!e.shippingAddress||["first_name","last_name","address_1","address_2","postcode","city","country","company"].some((t=>void 0===e.shippingAddress[t])))throw new Error("Missing required shipping address data in cart.");return e}resetCartData(){let e=this.getCartData();e.shippingAddress.first_name="",e.shippingAddress.last_name="",e.shippingAddress.address_1="",e.shippingAddress.address_2="",e.shippingAddress.postcode="",e.shippingAddress.city="",e.shippingAddress.country="",e.shippingAddress.company="",(0,s.dispatch)(r.CART_STORE_KEY).setCartData(e)}refreshPaymentMethods(){if(!this.allPaymentMethods.length)return console.warn("No payment methods available for filtering."),void this.loadAllPaymentMethods();const e=(0,s.select)(r.CART_STORE_KEY).getCartData();if(!e.paymentMethods)return console.warn("No payment methods found in cart data."),void(0,s.dispatch)(r.CART_STORE_KEY).invalidateResolution("getCartData");const t=(0,n.getSetting)("resursbank_data",{}).payment_methods||[],a=new Map(t.map((e=>[e.id?.toLowerCase()||e.name?.toLowerCase(),e]))),o="LEGAL"===this.widget.getCustomerType(),i=parseInt(e.totals.total_price,10)/Math.pow(10,e.totals.currency_minor_unit),d=this.allPaymentMethods.map((e=>{const t=e?.toLowerCase().trim(),s=a.get(t);if(s){const{enabled_for_legal_customer:t,enabled_for_natural_customer:r,min_purchase_limit:n,max_purchase_limit:a}=s;return(o&&t||!o&&r||!o&&t&&r)&&i>=n&&i<=a?e:null}return e})).filter(Boolean);(0,s.dispatch)(r.CART_STORE_KEY).setCartData({...e,paymentMethods:d})}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelector(".woocommerce-checkout")&&"function"==typeof Resursbank_GetAddress&&(document.querySelector(".wc-block-components-form")?(new a).initialize():new MutationObserver(((e,t)=>{document.querySelector(".wc-block-components-form")&&((new a).initialize(),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0}),(new t).initialize())}))})();